<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Sensei pro ČZU</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .lesson-bubble { position: relative; cursor: grab; }
        .lesson-bubble:active { cursor: grabbing; transform: scale(1.05); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .dragging { opacity: 0.5; border: 2px dashed #166534; }
        .drag-over { border-style: dashed; border-color: #166534; background-color: #f0fdf4; }
        .view-transition { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .form-input {
            border: 1px solid #cbd5e1;
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .form-input:focus {
            outline: none;
            border-color: #166534;
            box-shadow: 0 0 0 2px rgba(22, 101, 52, 0.2);
        }
        .upload-zone.drag-over-file {
            border-color: #166534;
            background-color: #f0fdf4;
        }
    </style>
</head>
<body class="bg-slate-100">

    <div id="app-container">
        </div>

    <script type="module">
        // Import potřebných modulů z Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, getDocs, query, orderBy, doc, getDoc, setDoc, addDoc, serverTimestamp, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getStorage } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";
        // Import našeho nového modulu pro nahrávání
        import { initializeUpload } from './js/upload-handler.js';

        // Vaše web app's Firebase konfigurace
        const firebaseConfig = {
          apiKey: "AIzaSyB3mUbw9cC8U6UzUNvPadrwdhjXFcu3aeA",
          authDomain: "ai-sensei-czu-pilot.firebaseapp.com",
          projectId: "ai-sensei-czu-pilot",
          storageBucket: "ai-sensei-czu-pilot.appspot.com",
          messagingSenderId: "413145704611",
          appId: "1:413145704611:web:75f8e571995276f99af716",
          measurementId: "G-4QDC0F2Q6Q"
        };

        // Inicializace Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app); 

        const appContainer = document.getElementById('app-container');
        
        // --- STAV APLIKACE ---
        let allLessons = [];
        let timelineData = {};
        let currentView = 'timeline';
        let currentLesson = null;
        let activeEditorView = 'details';

        // --- HLAVNÍ FUNKCE APLIKACE ---

        function renderLoginScreen() {
            appContainer.innerHTML = `
                <div class="w-full h-screen flex items-center justify-center p-4">
                    <div class="w-full max-w-md p-8 lg:p-10 space-y-6 bg-white rounded-2xl shadow-xl text-center">
                        <div class="inline-block p-4 bg-green-100 rounded-full">
                            <span class="text-4xl font-black text-green-800">ČZU</span>
                        </div>
                        <h1 class="text-3xl font-extrabold text-slate-800">Vítejte v AI Sensei</h1>
                        <p class="text-slate-500">Zvolte prosím svou roli pro vstup do systému.</p>
                        <div class="space-y-4 pt-4">
                            <button id="login-professor" class="w-full py-3 px-4 rounded-xl shadow-sm text-lg font-semibold text-white bg-green-700 hover:bg-green-800 transition">Vstoupit jako Profesor</button>
                            <button id="login-student" class="w-full py-3 px-4 rounded-xl shadow-sm text-lg font-semibold text-white bg-amber-800 hover:bg-amber-900 transition">Vstoupit jako Student</button>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('login-professor').addEventListener('click', async () => {
                try {
                    await signInAnonymously(auth);
                } catch (error) {
                    console.error("Chyba při anonymním přihlášení:", error);
                    alert("Nepodařilo se přihlásit. Zkuste to prosím znovu.");
                }
            });
        }

        async function renderProfessorDashboard() {
            if (currentView === 'timeline') {
                await renderTimelineView();
            } else if (currentView === 'editor') {
                renderEditorView();
            }
        }

        async function renderTimelineView() {
            appContainer.innerHTML = `
                <div class="h-screen w-screen flex bg-white shadow-lg overflow-hidden">
                    <nav class="w-20 bg-green-800 p-3 flex flex-col items-center justify-between flex-shrink-0">
                         <div>
                            <a href="#" class="w-12 h-12 rounded-full flex items-center justify-center mb-8 bg-white text-green-800" title="AI Sensei pro ČZU">
                                <span class="text-xl font-black">ČZU</span>
                            </a>
                        </div>
                        <button id="logout-btn" class="p-3 rounded-lg flex items-center justify-center text-green-200 hover:bg-green-700 hover:text-white transition-colors" title="Odhlásit">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                        </button>
                    </nav>
                    <aside id="professor-sidebar" class="w-full md:w-96 bg-white border-r border-slate-200 flex flex-col flex-shrink-0">
                        <div class="p-4 border-b border-slate-200"><h2 class="text-xl font-bold text-slate-800">Načítání knihovny...</h2></div>
                    </aside>
                    <main id="main-content-area" class="flex-grow bg-slate-100 flex flex-col h-screen">
                        <div class="p-8 text-center"><p>Načítání časové osy...</p></div>
                    </main>
                </div>
            `;
            document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));
            await fetchAndRenderLessons();
        }

        function renderEditorView() {
             appContainer.innerHTML = `
                <div class="h-screen w-screen flex bg-white shadow-lg overflow-hidden">
                     <nav class="w-20 bg-green-800 p-3 flex flex-col items-center justify-between flex-shrink-0">
                         <div>
                            <a href="#" class="w-12 h-12 rounded-full flex items-center justify-center mb-8 bg-white text-green-800" title="AI Sensei pro ČZU">
                                <span class="text-xl font-black">ČZU</span>
                            </a>
                        </div>
                        <button id="logout-btn" class="p-3 rounded-lg flex items-center justify-center text-green-200 hover:bg-green-700 hover:text-white transition-colors" title="Odhlásit">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                        </button>
                    </nav>
                    <aside id="professor-sidebar" class="w-full md:w-96 bg-white border-r border-slate-200 flex flex-col flex-shrink-0 view-transition"></aside>
                    <main id="main-content-area" class="flex-grow bg-slate-100 flex flex-col h-screen view-transition"></main>
                </div>
            `;
            
            document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));
            renderEditorSidebar();
            renderEditorContent(activeEditorView);
        }

        function renderEditorSidebar() {
            const sidebar = document.getElementById('professor-sidebar');
            const menuItems = [
                { id: 'details', label: 'Detaily lekce', icon: '📝' },
                { id: 'docs', label: 'Dokumenty k lekci', icon: '📁' },
                { id: 'text', label: 'Text pro studenty', icon: '✍️' },
                { id: 'presentation', label: 'Prezentace', icon: '🖼️' },
                { id: 'video', label: 'Video', icon: '▶️' },
                { id: 'quiz', label: 'Kvíz', icon: '❓' },
                { id: 'test', label: 'Test', icon: '✅' },
                { id: 'post', label: 'Podcast & Materiály', icon: '🎙️' }
            ];

            const menuHTML = menuItems.map(item => `
                <a href="#" data-view="${item.id}" class="editor-menu-item flex items-center p-3 text-sm font-medium rounded-md hover:bg-slate-100 transition-colors">
                    ${item.icon}<span class="ml-3">${item.label}</span>
                </a>
            `).join('');

            sidebar.innerHTML = `
                <header class="p-4 border-b border-slate-200 flex-shrink-0">
                    <button id="back-to-timeline-btn" class="flex items-center text-sm text-green-700 hover:underline mb-3">&larr; Zpět na plán výuky</button>
                    <div class="flex items-center space-x-3">
                        <span id="lesson-icon-display" class="text-3xl">${currentLesson ? currentLesson.icon : '🆕'}</span>
                        <h2 id="lesson-title-display" class="text-xl font-bold truncate text-slate-800">${currentLesson ? currentLesson.title : 'Vytvořit novou lekci'}</h2>
                    </div>
                </header>
                <div class="flex-grow overflow-y-auto p-2">
                   <nav>${menuHTML}</nav>
                </div>
            `;

            document.getElementById('back-to-timeline-btn').addEventListener('click', () => {
                currentView = 'timeline';
                currentLesson = null;
                renderProfessorDashboard();
            });

            sidebar.querySelectorAll('.editor-menu-item').forEach(item => {
                item.addEventListener('click', e => {
                    e.preventDefault();
                    activeEditorView = item.dataset.view;
                    renderEditorContent(activeEditorView);
                });
            });
        }
        
        async function renderEditorContent(viewId) {
            const mainArea = document.getElementById('main-content-area');
            let contentHTML = '';

            document.querySelectorAll('.editor-menu-item').forEach(el => {
                el.classList.toggle('bg-green-100', el.dataset.view === viewId);
                el.classList.toggle('text-green-800', el.dataset.view === viewId);
                el.classList.toggle('font-semibold', el.dataset.view === viewId);
            });
            
            const renderWrapper = (title, content) => `<div class="p-8 overflow-y-auto h-full"><h2 class="text-3xl font-extrabold text-slate-800 mb-6">${title}</h2><div class="bg-white p-6 rounded-2xl shadow-lg">${content}</div></div>`;

            switch(viewId) {
                case 'details':
                    contentHTML = renderWrapper('Detaily lekce', `
                        <div id="lesson-details-form" class="space-y-4">
                            <div><label class="block font-medium text-slate-600 mb-1">Název lekce</label><input id="lesson-title" type="text" class="w-full p-2 rounded-lg form-input" value="${currentLesson?.title || ''}"></div>
                            <div><label class="block font-medium text-slate-600 mb-1">Podtitulek</label><input id="lesson-subtitle" type="text" class="w-full p-2 rounded-lg form-input" value="${currentLesson?.subtitle || ''}"></div>
                            <div><label class="block font-medium text-slate-600 mb-1">Ikona (emoji)</label><input id="lesson-icon" type="text" class="w-full p-2 rounded-lg form-input" value="${currentLesson?.icon || '🆕'}"></div>
                            <div class="text-right pt-4"><button id="save-lesson-btn" class="px-6 py-2 bg-green-700 text-white font-semibold rounded-lg hover:bg-green-800">Uložit lekci</button></div>
                        </div>
                    `);
                    break;
                case 'docs':
                    contentHTML = renderWrapper('Dokumenty k lekci', `
                        <p class="text-slate-500 mb-4">Nahrajte specifické soubory pro tuto lekci (např. sylabus, doplňkové texty).</p>
                        <label for="file-upload-input" id="upload-zone" class="block border-2 border-dashed border-slate-300 rounded-lg p-10 text-center text-slate-500 cursor-pointer hover:border-green-600 hover:bg-green-50 transition-colors">
                            <p class="font-semibold">Přetáhněte soubory sem nebo klikněte pro výběr</p>
                            <p class="text-sm">Maximální velikost 10MB</p>
                        </label>
                        <input type="file" id="file-upload-input" class="hidden" multiple>
                        <div id="upload-progress" class="mt-4 space-y-2"></div>
                        <h3 class="font-bold text-slate-700 mt-6 mb-2">Nahrané soubory:</h3>
                        <ul id="documents-list" class="space-y-2">
                           <li class="text-center text-slate-400 text-sm">Žádné dokumenty nebyly nahrány.</li>
                        </ul>`);
                    break;
                default:
                    contentHTML = renderWrapper('Sekce v přípravě', `<p>Obsah pro sekci '${viewId}' bude brzy doplněn.</p>`);
                    break;
            }
            mainArea.innerHTML = contentHTML;

            if (viewId === 'details') {
                document.getElementById('save-lesson-btn').addEventListener('click', saveLessonDetails);
            }
            if (viewId === 'docs') {
                initializeUpload(currentLesson, db, storage);
            }
        }

        async function saveLessonDetails() {
            const title = document.getElementById('lesson-title').value;
            const subtitle = document.getElementById('lesson-subtitle').value;
            const icon = document.getElementById('lesson-icon').value;

            if (!title) {
                alert("Název lekce je povinný.");
                return;
            }

            const lessonData = { title, subtitle, icon, status: currentLesson?.status || 'Naplánováno' };
            const saveBtn = document.getElementById('save-lesson-btn');
            saveBtn.disabled = true;
            saveBtn.textContent = 'Ukládám...';

            try {
                if (currentLesson) {
                    const lessonRef = doc(db, "lessons", currentLesson.id);
                    await updateDoc(lessonRef, lessonData);
                    alert("Lekce byla úspěšně aktualizována.");
                    currentLesson = { ...currentLesson, ...lessonData };
                } else {
                    lessonData.creationDate = serverTimestamp();
                    const docRef = await addDoc(collection(db, "lessons"), lessonData);
                    alert("Nová lekce byla úspěšně vytvořena. Nyní můžete nahrávat dokumenty.");
                    currentLesson = { id: docRef.id, ...lessonData };
                }
                document.getElementById('lesson-title-display').textContent = currentLesson.title;
                document.getElementById('lesson-icon-display').textContent = currentLesson.icon;

            } catch (error) {
                console.error("Chyba při ukládání lekce:", error);
                alert("Došlo k chybě při ukládání.");
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'Uložit lekci';
            }
        }
        
        async function fetchAndRenderLessons() {
            try {
                const q = query(collection(db, "lessons"), orderBy("creationDate", "desc"));
                const querySnapshot = await getDocs(q);
                allLessons = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                const timelineDocRef = doc(db, "timeline", "professorView");
                const timelineDoc = await getDoc(timelineDocRef);
                timelineData = timelineDoc.exists() ? timelineDoc.data() : {};
                
                renderLessonLibrary(allLessons);
                renderTimeline();
            } catch (error) {
                console.error("Chyba při načítání dat z Firestore:", error);
                document.getElementById('professor-sidebar').innerHTML = `<div class="p-4 text-red-600">Nepodařilo se načíst data.</div>`;
            }
        }

        function renderLessonLibrary(lessons) {
            const sidebar = document.getElementById('professor-sidebar');
            const statuses = ['Aktivní', 'Naplánováno', 'Archivováno'];
            
            const libraryHTML = statuses.map(status => {
                const lessonsInStatus = lessons.filter(l => l.status === status);
                return `
                    <div class="p-2">
                        <h3 class="px-2 text-sm font-semibold text-slate-500 mb-2">${status}</h3>
                        ${lessonsInStatus.length > 0 ? lessonsInStatus.map(lesson => `
                            <div class="lesson-bubble p-3 mb-2 rounded-lg flex items-center space-x-3 cursor-pointer bg-white border border-slate-200 hover:shadow-md hover:border-green-500 transition-all" data-id="${lesson.id}" draggable="true">
                                <span class="text-2xl">${lesson.icon}</span>
                                <div>
                                    <span class="font-semibold text-sm text-slate-700">${lesson.title}</span>
                                    <p class="text-xs text-slate-500">${lesson.subtitle}</p>
                                </div>
                            </div>
                        `).join('') : '<p class="px-2 text-xs text-slate-400">Žádné lekce.</p>'}
                    </div>
                `;
            }).join('');

            sidebar.innerHTML = `
                <header class="p-4 border-b border-slate-200 flex justify-between items-center flex-shrink-0">
                    <h2 class="text-xl font-bold text-slate-800">Knihovna lekcí</h2>
                    <button id="new-lesson-btn" class="px-4 py-2 bg-green-700 text-white rounded-lg text-sm font-semibold hover:bg-green-800 transition">+ Nová lekce</button>
                </header>
                <div class="flex-grow overflow-y-auto">${libraryHTML}</div>
            `;

            document.getElementById('new-lesson-btn').addEventListener('click', () => {
                currentView = 'editor';
                currentLesson = null;
                activeEditorView = 'details';
                renderProfessorDashboard();
            });

            sidebar.querySelectorAll('.lesson-bubble').forEach(el => {
                el.addEventListener('click', () => {
                    currentView = 'editor';
                    currentLesson = allLessons.find(l => l.id === el.dataset.id);
                    activeEditorView = 'details';
                    renderProfessorDashboard();
                });
                
                el.addEventListener('dragstart', (e) => {
                    e.target.classList.add('dragging');
                    e.dataTransfer.setData('lesson_id', e.target.dataset.id);
                });
                el.addEventListener('dragend', (e) => e.target.classList.remove('dragging'));
            });
        }
        
        function renderTimeline() {
             const mainArea = document.getElementById('main-content-area');
             mainArea.innerHTML = `
                <header class="text-center p-6 border-b border-slate-200 bg-white">
                    <h1 class="text-3xl font-extrabold text-slate-800">Plán výuky</h1>
                    <p class="text-slate-500 mt-1">Naplánujte lekce přetažením z knihovny vlevo.</p>
                </header>
                <div class="flex-grow overflow-y-auto p-4 md:p-6">
                    <div id="timeline-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-4"></div>
                </div>
             `;

            const timelineContainer = document.getElementById('timeline-container');
            timelineContainer.innerHTML = '';
            const startDate = new Date();
            for (let i = 0; i < 10; i++) {
                const dayDate = new Date();
                dayDate.setDate(startDate.getDate() + i);
                const dayKey = dayDate.toISOString().split('T')[0];
                
                const dayWrapper = document.createElement('div');
                dayWrapper.className = 'day-slot bg-white rounded-xl p-3 border-2 border-transparent transition-colors min-h-[250px] shadow-sm flex flex-col';
                dayWrapper.dataset.dayKey = dayKey;
                
                const formattedDate = dayDate.toLocaleDateString('cs-CZ', { weekday: 'long', day: 'numeric', month: 'numeric' });
                let lessonsHTML = '';
                if (timelineData[dayKey]) {
                    lessonsHTML = timelineData[dayKey].map(lessonId => {
                        const lesson = allLessons.find(l => l.id === lessonId);
                        if (!lesson) return '';
                        return `<div class="lesson-bubble-in-timeline p-2 mt-2 rounded-lg flex items-center space-x-2 bg-green-100 border border-green-200 text-sm"><span class="text-lg">${lesson.icon}</span><span class="font-semibold">${lesson.title}</span></div>`;
                    }).join('');
                }

                dayWrapper.innerHTML = `
                    <div class="text-center pb-2 mb-2 border-b border-slate-200"><p class="font-bold text-slate-700">${formattedDate}</p></div>
                    <div class="lessons-container flex-grow">${lessonsHTML}</div>
                `;
                timelineContainer.appendChild(dayWrapper);
            }

            addDragAndDropListeners();
        }

        function addDragAndDropListeners() {
            document.querySelectorAll('.day-slot').forEach(zone => {
                zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('drag-over'); });
                zone.addEventListener('dragleave', () => zone.classList.remove('drag-over'); });
                zone.addEventListener('drop', async (e) => {
                    e.preventDefault();
                    zone.classList.remove('drag-over');
                    const lessonId = e.dataTransfer.getData('lesson_id');
                    const dayKey = zone.dataset.dayKey;

                    Object.keys(timelineData).forEach(key => {
                        timelineData[key] = timelineData[key].filter(id => id !== lessonId);
                    });

                    if (!timelineData[dayKey]) {
                        timelineData[dayKey] = [];
                    }
                    if (!timelineData[dayKey].includes(lessonId)) {
                        timelineData[dayKey].push(lessonId);
                    }
                    
                    await saveTimelineToFirestore();
                    renderTimeline();
                });
            });
        }
        
        async function saveTimelineToFirestore() {
            try {
                const timelineDocRef = doc(db, "timeline", "professorView");
                await setDoc(timelineDocRef, timelineData);
                console.log("Časová osa uložena do Firestore.");
            } catch (error) {
                console.error("Chyba při ukládání časové osy:", error);
                alert("Došlo k chybě při ukládání změn.");
            }
        }

        // --- ROUTER APLIKACE ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                renderProfessorDashboard();
            } else {
                renderLoginScreen();
            }
        });
    </script>
</body>
</html>