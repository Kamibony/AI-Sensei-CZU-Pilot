rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Allow any authenticated user to read all lesson-related data.
    // This is the primary fix for the 400 Bad Request on the /Listen channel.
    // Write access is kept open for now to allow professors to manage content.
    match /lessons/{lessonId}/{documents=**} {
      allow read, write: if request.auth != null;
    }

    // Allow authenticated users (like professors) to read the list of students,
    // but only allow a student to write to their own document.
    match /students/{studentId}/{documents=**} {
      allow read: if request.auth != null;
      allow write: if request.auth.uid == studentId;
    }

    // Allow any authenticated user to manage timeline events for now.
    // This will be restricted to a professor role in the future.
    match /timeline_events/{eventId} {
       allow read, write: if request.auth != null;
    }
  }
}