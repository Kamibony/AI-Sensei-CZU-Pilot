rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {

    function isProfessor() {
      return request.auth != null && request.auth.token.role == 'professor';
    }

    // Helper function to safely check for ownership via file metadata
    function isOwner(fileResource) {
      return fileResource.metadata != null &&
             'ownerId' in fileResource.metadata &&
             fileResource.metadata.ownerId == request.auth.uid;
    }

    match /public-assets/{allPaths=**} {
      allow read;
    }

    match /courses/{courseId}/media/{fileId} {

      // READ is allowed for the owner or the legacy admin
      allow read: if (isProfessor() && isOwner(resource))
                  || request.auth.token.email == 'profesor@profesor.cz';

      // CREATE is disallowed. Uploads must use signed URLs.
      allow create: if false;

      // DELETE is allowed for the owner or the legacy admin
      // Also allow professors to delete "orphaned" files (missing metadata/ownerId) to clean up broken uploads
      allow delete: if (isProfessor() && (isOwner(resource) || resource.metadata == null || !('ownerId' in resource.metadata)))
                    || request.auth.token.email == 'profesor@profesor.cz';
    }

    // Default deny all other paths
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
