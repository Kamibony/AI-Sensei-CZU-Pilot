// Verzia: Opravená pre Multi-Profesor a Storage Rules syntax

rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {

    // Pravidlá pre priečinok každého profesora: /{profId}/media/{fileName}
    match /{profId}/media/{fileName=**} {
    
      // ZÁPIS (upload, delete):
      // Povolí iba prihlásenému používateľovi, ktorý je profesor
      // a zapisuje do SVOJHO VLASTNÉHO priečinka (profId == jeho uid).
      allow write: if request.auth != null &&
                      request.auth.token.role == 'professor' &&
                      profId == request.auth.uid;

      // ČÍTANIE (download):
      // Povolí profesorovi čítať zo SVOJHO priečinka.
      allow read: if request.auth != null &&
                     request.auth.token.role == 'professor' &&
                     profId == request.auth.uid;
                     
      // ČÍTANIE (download) pre študenta:
      // Povolí študentovi čítať súbory, ale IBA z priečinka
      // SVOJHO priradeného profesora.
      // 
      // DÔLEŽITÉ: Toto bude fungovať, až keď v Cloud Function
      // nastavíte študentovi Custom Claim 'professorId'.
      // Napr: admin.auth().setCustomUserClaims(studentUid, { role: "student", professorId: "..." });
      allow read: if request.auth != null &&
                     request.auth.token.role == 'student' &&
                     profId == request.auth.token.professorId;
    }
  }
}
