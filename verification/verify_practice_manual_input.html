
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Verify Practice View Manual Input</title>
    <script type="importmap">
        {
            "imports": {
                "/public/js/services/professor-data-service.js": "./mock_deps.js",
                "/public/js/firebase-init.js": "./mock_deps.js",
                "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js": "./mock_deps.js",
                "https://cdn.jsdelivr.net/gh/lit/dist@3/core/lit-core.min.js": "https://cdn.jsdelivr.net/gh/lit/dist@3/core/lit-core.min.js"
            }
        }
    </script>
</head>
<body>
    <div id="app"></div>

    <script type="module">
        import { PracticeView } from '/public/js/views/professor/practice-view.js';

        // Helper to wait for updates
        const waitForUpdate = async (el) => {
            await el.updateComplete;
            await new Promise(r => setTimeout(r, 50));
        };

        async function runTest() {
            const app = document.getElementById('app');
            const el = new PracticeView();
            app.appendChild(el);

            console.log('--- Mounting View ---');
            await waitForUpdate(el);

            // 1. Verify Groups Loaded (Mocked)
            console.log('Groups:', el.groups);
            if (el.groups.length === 0) throw new Error("Groups not loaded");

            // 2. Select Group (Triggered automatically if 1 group, but let's ensure)
            // The mock returns 1 group, code auto-selects.
            if (!el.selectedGroupId) throw new Error("Group not auto-selected");
            console.log('Selected Group:', el.selectedGroupId);

            // 3. Verify Initial State (No Active Session)
            // Check for Textarea and Start Button
            const textarea = el.shadowRoot.querySelector('textarea');
            const startBtn = el.shadowRoot.querySelector('button.btn-primary'); // "Zahájit výcvik"

            if (!textarea) throw new Error("Textarea should be visible before session start");
            if (!startBtn) throw new Error("Start button should be visible before session start");
            if (!startBtn.disabled && textarea.value.trim() === '') {
                 // It might be enabled if logic is wrong, wait, disabled is a boolean attribute.
                 // In Lit: ?disabled="${expr}". If true, attribute exists.
                 if (!startBtn.hasAttribute('disabled')) console.warn("Start button should be disabled when empty");
            }

            console.log('--- Testing Manual Input ---');
            // 4. Simulate Typing
            textarea.value = "Test Task 123";
            textarea.dispatchEvent(new Event('input', { bubbles: true, composed: true }));
            await waitForUpdate(el);

            console.log('Active Task State:', el.activeTask);
            if (el.activeTask !== "Test Task 123") throw new Error("State not updated from textarea input");

            // 5. Verify Button Enabled
            if (startBtn.hasAttribute('disabled')) throw new Error("Start button should be enabled after input");

            console.log('--- Testing Session Creation ---');
            // 6. Click Start
            startBtn.click();

            // Wait a bit for async call
            await new Promise(r => setTimeout(r, 100));

            // Verify Mock Service Call
            if (!window.lastCreatedSession) throw new Error("createPracticalSession was not called");
            if (window.lastCreatedSession.activeTask !== "Test Task 123") {
                throw new Error(`Expected activeTask 'Test Task 123', got '${window.lastCreatedSession.activeTask}'`);
            }

            console.log('SUCCESS: createPracticalSession called with correct task!');

            // 7. Test Voice Input (Mocked)
            console.log('--- Testing Voice Input Appending ---');
            // Simulate voice result
            // Mock recognition is tricky as it's inside the method.
            // But we can manually invoke _handleVoiceInput or better, simulate the button click if we can mock window.SpeechRecognition.

            // Let's attach a mock SpeechRecognition to window
            window.SpeechRecognition = class {
                constructor() {
                    this.onresult = null;
                    this.onstart = null;
                    this.onend = null;
                }
                start() {
                    if (this.onstart) this.onstart();
                    setTimeout(() => {
                        const evt = { results: [[{ transcript: "Voice Part" }]] };
                        if (this.onresult) this.onresult(evt);
                        if (this.onend) this.onend();
                    }, 50);
                }
                stop() {}
            };

            // Trigger Voice
            // Find mic button
            const micBtn = el.shadowRoot.querySelector('.btn-record');
            if (micBtn) {
                micBtn.click();
                await new Promise(r => setTimeout(r, 200)); // Wait for mock timeout
                await waitForUpdate(el);

                console.log('Active Task after Voice:', el.activeTask);
                // "Test Task 123" + " " + "Voice Part" -> "Test Task 123 Voice Part"
                if (el.activeTask !== "Test Task 123 Voice Part") {
                    throw new Error(`Voice input should append. Got: '${el.activeTask}'`);
                }
                console.log('SUCCESS: Voice input appended correctly!');
            } else {
                console.warn("Mic button not found (Speech not supported mock?)");
            }

            document.body.innerHTML += '<h1 style="color:green">ALL TESTS PASSED</h1>';
        }

        runTest().catch(e => {
            console.error(e);
            document.body.innerHTML += `<h1 style="color:red">TEST FAILED: ${e.message}</h1>`;
        });
    </script>
</body>
</html>
